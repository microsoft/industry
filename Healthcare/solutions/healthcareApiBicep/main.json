{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.613.9944",
      "templateHash": "8052746599742551528"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Specifies the location for all resources."
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "metadata": {
        "description": "Specifies the environment of the deployment."
      },
      "allowedValues": [
        "dev",
        "tst",
        "prd"
      ]
    },
    "prefix": {
      "type": "string",
      "metadata": {
        "description": "Specifies the prefix for all resources created in this deployment."
      },
      "maxLength": 10,
      "minLength": 2
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Specifies the tags that you want to apply to all resources."
      }
    },
    "enableRoleAssignments": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Specifies whether role assignments should be enabled."
      }
    },
    "fhirStorageAccountId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the storage account file system resource id used for FHIR."
      }
    },
    "iotDeviceMapping": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Specifies the iot device mapping."
      }
    },
    "iotFhirMapping": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Specifies the fhir mapping."
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the resource ID of the subnet to which all services will connect."
      }
    },
    "privateDnsZoneIdEventhubNamespace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for EventHub Namespaces."
      }
    },
    "privateDnsZoneIdHealthcareApi": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specifies the resource ID of the private DNS zone for healthcare API workspaces."
      }
    }
  },
  "functions": [],
  "variables": {
    "name": "[toLower(format('{0}-{1}', parameters('prefix'), parameters('environment')))]",
    "eventhubNamespace001Name": "[format('{0}-eventhub001', variables('name'))]",
    "healthcareApi001Name": "[format('{0}-hapi001', variables('name'))]",
    "fhirStorageAccountSubscriptionId": "[if(greaterOrEquals(length(split(parameters('fhirStorageAccountId'), '/')), 9), split(parameters('fhirStorageAccountId'), '/')[2], subscription().subscriptionId)]",
    "fhirStorageAccountResourceGroupName": "[if(greaterOrEquals(length(split(parameters('fhirStorageAccountId'), '/')), 9), split(parameters('fhirStorageAccountId'), '/')[4], resourceGroup().name)]",
    "fhirStorageAccountName": "[if(greaterOrEquals(length(split(parameters('fhirStorageAccountId'), '/')), 9), last(split(parameters('fhirStorageAccountId'), '/')), 'incorrectSegmentLength')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "eventhubNamespace001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "eventhubnamespaceName": {
            "value": "[variables('eventhubNamespace001Name')]"
          },
          "privateDnsZoneIdEventhubNamespace": {
            "value": "[parameters('privateDnsZoneIdEventhubNamespace')]"
          },
          "eventhubnamespaceMinThroughput": {
            "value": 1
          },
          "eventhubnamespaceMaxThroughput": {
            "value": 1
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "9796843697030289654"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "eventhubnamespaceName": {
              "type": "string"
            },
            "eventhubnamespaceMinThroughput": {
              "type": "int",
              "maxValue": 20,
              "minValue": 1
            },
            "eventhubnamespaceMaxThroughput": {
              "type": "int",
              "maxValue": 20,
              "minValue": 1
            },
            "privateDnsZoneIdEventhubNamespace": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "functions": [],
          "variables": {
            "eventhub001Name": "eventHub001",
            "eventHub001ConsumerGroupName": "healthcareapiiot",
            "eventhubNamespacePrivateEndpointName": "[format('{0}-private-endpoint', parameters('eventhubnamespaceName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.EventHub/namespaces",
              "apiVersion": "2021-01-01-preview",
              "name": "[parameters('eventhubnamespaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "sku": {
                "name": "Standard",
                "tier": "Standard",
                "capacity": "[parameters('eventhubnamespaceMinThroughput')]"
              },
              "properties": {
                "isAutoInflateEnabled": true,
                "kafkaEnabled": true,
                "maximumThroughputUnits": "[parameters('eventhubnamespaceMaxThroughput')]",
                "zoneRedundant": true
              }
            },
            {
              "type": "Microsoft.EventHub/namespaces/eventhubs",
              "apiVersion": "2021-01-01-preview",
              "name": "[format('{0}/{1}', parameters('eventhubnamespaceName'), variables('eventhub001Name'))]",
              "properties": {
                "messageRetentionInDays": 3,
                "partitionCount": 1,
                "status": "Active"
              },
              "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]"
              ]
            },
            {
              "type": "Microsoft.EventHub/namespaces/eventhubs/consumergroups",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('eventhubnamespaceName'), variables('eventhub001Name'), variables('eventHub001ConsumerGroupName'))]",
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces/eventhubs', parameters('eventhubnamespaceName'), variables('eventhub001Name'))]",
                "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('eventhubNamespacePrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('eventhubNamespacePrivateEndpointName')]",
                    "properties": {
                      "groupIds": [
                        "namespace"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneIdEventhubNamespace')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('eventhubNamespacePrivateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('eventhubNamespacePrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdEventhubNamespace')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('eventhubNamespacePrivateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "eventhubNamespaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.EventHub/namespaces', parameters('eventhubnamespaceName'))]"
            },
            "eventhubNamespaceFqdn": {
              "type": "string",
              "value": "[format('{0}.servicesbus.windows.net', parameters('eventhubnamespaceName'))]"
            },
            "eventhub001Name": {
              "type": "string",
              "value": "[variables('eventhub001Name')]"
            },
            "eventhub001ConsumerGroupName": {
              "type": "string",
              "value": "[variables('eventHub001ConsumerGroupName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "healthcareApi001",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "subnetId": {
            "value": "[parameters('subnetId')]"
          },
          "healthcareapiFhirVersion": {
            "value": "fhir-R4"
          },
          "privateDnsZoneIdHealthcareApi": {
            "value": "[parameters('privateDnsZoneIdHealthcareApi')]"
          },
          "healthcareapiName": {
            "value": "[variables('healthcareApi001Name')]"
          },
          "healthcareapiFhirStorageAccountName": {
            "value": "[variables('fhirStorageAccountName')]"
          },
          "healthcareapiIotEventhubName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001'), '2019-10-01').outputs.eventhub001Name.value]"
          },
          "healthcareapiIotEventhubConsumerGroupName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001'), '2019-10-01').outputs.eventhub001ConsumerGroupName.value]"
          },
          "healthcareapiIotEventhubNamespaceFqdn": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001'), '2019-10-01').outputs.eventhubNamespaceFqdn.value]"
          },
          "healthcareapiIotDeviceMapping": {
            "value": "[parameters('iotDeviceMapping')]"
          },
          "healthcareapiIotFhirMapping": {
            "value": "[parameters('iotFhirMapping')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "5919009700492757365"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "subnetId": {
              "type": "string"
            },
            "healthcareapiName": {
              "type": "string"
            },
            "privateDnsZoneIdHealthcareApi": {
              "type": "string",
              "defaultValue": ""
            },
            "healthcareapiFhirVersion": {
              "type": "string",
              "defaultValue": "fhir-R4",
              "allowedValues": [
                "fhir-Stu3",
                "fhir-R4"
              ]
            },
            "healthcareapiFhirStorageAccountName": {
              "type": "string",
              "defaultValue": ""
            },
            "healthcareapiIotDeviceMapping": {
              "type": "object"
            },
            "healthcareapiIotFhirMapping": {
              "type": "object"
            },
            "healthcareapiIotEventhubNamespaceFqdn": {
              "type": "string"
            },
            "healthcareapiIotEventhubName": {
              "type": "string"
            },
            "healthcareapiIotEventhubConsumerGroupName": {
              "type": "string"
            }
          },
          "functions": [],
          "variables": {
            "healthcareapiNameCleaned": "[toLower(replace(parameters('healthcareapiName'), '-', ''))]",
            "healthcareapiFhirName": "[format('{0}fhir', variables('healthcareapiNameCleaned'))]",
            "healthcareapiDicomName": "[format('{0}dicom', variables('healthcareapiNameCleaned'))]",
            "healthcareapiIotName": "[format('{0}iot', variables('healthcareapiNameCleaned'))]",
            "healthcareapiPrivateEndpointName": "[format('{0}-private-endpoint', variables('healthcareapiNameCleaned'))]"
          },
          "resources": [
            {
              "type": "Microsoft.HealthcareApis/workspaces",
              "apiVersion": "2021-06-01-preview",
              "name": "[variables('healthcareapiNameCleaned')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {}
            },
            {
              "condition": "[false()]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-11-01",
              "name": "[variables('healthcareapiPrivateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "manualPrivateLinkServiceConnections": [],
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('healthcareapiPrivateEndpointName')]",
                    "properties": {
                      "groupIds": [
                        "workspace"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.HealthcareApis/workspaces', variables('healthcareapiNameCleaned'))]",
                      "requestMessage": ""
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.HealthcareApis/workspaces', variables('healthcareapiNameCleaned'))]"
              ]
            },
            {
              "condition": "[and(false(), not(empty(parameters('privateDnsZoneIdHealthcareApi'))))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-11-01",
              "name": "[format('{0}/{1}', variables('healthcareapiPrivateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-arecord', variables('healthcareapiPrivateEndpointName'))]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneIdHealthcareApi')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('healthcareapiPrivateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.HealthcareApis/workspaces/fhirservices",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}', variables('healthcareapiNameCleaned'), variables('healthcareapiFhirName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "kind": "[parameters('healthcareapiFhirVersion')]",
              "properties": {
                "accessPolicies": [],
                "authenticationConfiguration": {
                  "audience": "[format('https://{0}-stu3.fhir.azurehealthcareapis.com', variables('healthcareapiNameCleaned'))]",
                  "authority": "[format('https://login.microsoftonline.com/{0}', subscription().tenantId)]",
                  "smartProxyEnabled": false
                },
                "acrConfiguration": {
                  "loginServers": []
                },
                "corsConfiguration": {
                  "allowCredentials": false,
                  "headers": [
                    "*"
                  ],
                  "maxAge": 1440,
                  "methods": [
                    "DELETE",
                    "GET",
                    "OPTIONS",
                    "PATCH",
                    "POST",
                    "PUT"
                  ],
                  "origins": [
                    "https://localhost:6001"
                  ]
                },
                "exportConfiguration": {
                  "storageAccountName": "[parameters('healthcareapiFhirStorageAccountName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.HealthcareApis/workspaces', variables('healthcareapiNameCleaned'))]"
              ]
            },
            {
              "type": "Microsoft.HealthcareApis/workspaces/dicomservices",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}', variables('healthcareapiNameCleaned'), variables('healthcareapiDicomName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "authenticationConfiguration": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.HealthcareApis/workspaces', variables('healthcareapiNameCleaned'))]"
              ]
            },
            {
              "condition": "[and(not(empty(parameters('healthcareapiIotDeviceMapping'))), not(empty(parameters('healthcareapiIotFhirMapping'))))]",
              "type": "Microsoft.HealthcareApis/workspaces/iotconnectors",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}', variables('healthcareapiNameCleaned'), variables('healthcareapiIotName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "deviceMapping": {
                  "content": "[parameters('healthcareapiIotDeviceMapping')]"
                },
                "ingestionEndpointConfiguration": {
                  "fullyQualifiedEventHubNamespace": "[parameters('healthcareapiIotEventhubNamespaceFqdn')]",
                  "eventHubName": "[parameters('healthcareapiIotEventhubName')]",
                  "consumerGroup": "[parameters('healthcareapiIotEventhubConsumerGroupName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.HealthcareApis/workspaces', variables('healthcareapiNameCleaned'))]"
              ]
            },
            {
              "condition": "[and(not(empty(parameters('healthcareapiIotDeviceMapping'))), not(empty(parameters('healthcareapiIotFhirMapping'))))]",
              "type": "Microsoft.HealthcareApis/workspaces/iotconnectors/fhirdestinations",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}/{2}', variables('healthcareapiNameCleaned'), variables('healthcareapiIotName'), variables('healthcareapiFhirName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "resourceIdentityResolutionType": "Create",
                "fhirMapping": {
                  "content": "[parameters('healthcareapiIotFhirMapping')]"
                },
                "fhirServiceResourceId": "[resourceId('Microsoft.HealthcareApis/workspaces/fhirservices', variables('healthcareapiNameCleaned'), variables('healthcareapiFhirName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.HealthcareApis/workspaces', variables('healthcareapiNameCleaned'))]",
                "[resourceId('Microsoft.HealthcareApis/workspaces/fhirservices', variables('healthcareapiNameCleaned'), variables('healthcareapiFhirName'))]",
                "[resourceId('Microsoft.HealthcareApis/workspaces/iotconnectors', variables('healthcareapiNameCleaned'), variables('healthcareapiIotName'))]"
              ]
            }
          ],
          "outputs": {
            "healthcareapiFhirId": {
              "type": "string",
              "value": "[resourceId('Microsoft.HealthcareApis/workspaces/fhirservices', variables('healthcareapiNameCleaned'), variables('healthcareapiFhirName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'eventhubNamespace001')]"
      ]
    },
    {
      "condition": "[parameters('enableRoleAssignments')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "healthcareApi001RoleAssignmentStorage",
      "subscriptionId": "[variables('fhirStorageAccountSubscriptionId')]",
      "resourceGroup": "[variables('fhirStorageAccountResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "healthcareapiFhirId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'healthcareApi001'), '2019-10-01').outputs.healthcareapiFhirId.value]"
          },
          "storageAccountId": {
            "value": "[parameters('fhirStorageAccountId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "2986010124291481587"
            }
          },
          "parameters": {
            "storageAccountId": {
              "type": "string"
            },
            "healthcareapiFhirId": {
              "type": "string"
            }
          },
          "functions": [],
          "variables": {
            "storageAccountName": "[if(greaterOrEquals(length(split(parameters('storageAccountId'), '/')), 9), last(split(parameters('storageAccountId'), '/')), 'incorrectSegmentLength')]",
            "healthcareapiSubscriptionId": "[if(greaterOrEquals(length(split(parameters('healthcareapiFhirId'), '/')), 11), split(parameters('healthcareapiFhirId'), '/')[2], subscription().subscriptionId)]",
            "healthcareapiResourceGroupName": "[if(greaterOrEquals(length(split(parameters('healthcareapiFhirId'), '/')), 11), split(parameters('healthcareapiFhirId'), '/')[4], resourceGroup().name)]",
            "healthcareapiName": "[if(greaterOrEquals(length(split(parameters('healthcareapiFhirId'), '/')), 11), split(parameters('healthcareapiFhirId'), '/')[8], 'incorrectSegmentLength')]",
            "healthcareapiFhirName": "[if(greaterOrEquals(length(split(parameters('healthcareapiFhirId'), '/')), 11), last(split(parameters('healthcareapiFhirId'), '/')), 'incorrectSegmentLength')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
              "name": "[guid(uniqueString(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('healthcareapiSubscriptionId'), variables('healthcareapiResourceGroupName')), 'Microsoft.HealthcareApis/workspaces/fhirservices', variables('healthcareapiName'), variables('healthcareapiFhirName'))))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('healthcareapiSubscriptionId'), variables('healthcareapiResourceGroupName')), 'Microsoft.HealthcareApis/workspaces/fhirservices', variables('healthcareapiName'), variables('healthcareapiFhirName')), '2021-06-01-preview', 'full').identity.principalId]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'healthcareApi001')]"
      ]
    }
  ]
}