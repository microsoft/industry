{
    "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "topLevelManagementGroupPrefix": {
            "type": "string",
            "defaultValue": "FSIDemo"
        }
    },
    "variables": {
        "scope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('topLevelManagementGroupPrefix'))]",
        "policies": {
            "policyDefinitions": [
                {
                    "properties": {
                        "displayName": "Storage accounts should use customer-managed key for encryption",
                        "mode": "Indexed",
                        "description": "Secure your blob and file storage account with greater flexibility using customer-managed keys. When you specify a customer-managed key, that key is used to protect and control access to the key that encrypts your data. Using customer-managed keys provides additional capabilities to control rotation of the key encryption key or cryptographically erase data.",
                        "metadata": {
                            "version": "1.0.3",
                            "category": "Storage"
                        },
                        "parameters": {
                            "effect": {
                                "type": "String",
                                "metadata": {
                                    "displayName": "Effect",
                                    "description": "Enable or disable the execution of the policy"
                                },
                                "allowedValues": [
                                    "Audit",
                                    "Deny",
                                    "Disabled"
                                ],
                                "defaultValue": "Deny"
                            }
                        },
                        "policyRule": {
                            "if": {
                                "allOf": [
                                    {
                                        "field": "type",
                                        "equals": "Microsoft.Storage/storageAccounts"
                                    },
                                    {
                                        "not": {
                                            "field": "Microsoft.Storage/storageAccounts/encryption.keySource",
                                            "equals": "Microsoft.Keyvault"
                                        }
                                    }
                                ]
                            },
                            "then": {
                                "effect": "[[parameters('effect')]"
                            }
                        }
                    },
                    "name": "Deny-Storage-Cmk"
                }
            ]
        }
    },
    "resources": [
        {
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "[variables('policies').policyDefinitions[copyIndex()].name]",
            "apiVersion": "2019-09-01",
            "copy": {
                "name": "policyDefinitionCopy",
                "count": "[length(variables('policies').policyDefinitions)]"
            },
            "properties": {
                "displayName": "[variables('policies').policyDefinitions[copyIndex()].properties.displayName]",
                "description": "[variables('policies').policyDefinitions[copyIndex()].properties.description]",
                "mode": "[variables('policies').policyDefinitions[copyIndex()].properties.mode]",
                "policyType": "Custom",
                "parameters": "[variables('policies').policyDefinitions[copyIndex()].properties.parameters]",
                "policyRule": "[variables('policies').policyDefinitions[copyIndex()].properties.policyRule]",
                "metadata": "[variables('policies').policyDefinitions[copyIndex()].properties.metadata]"
            }
        },
        {
            "type": "Microsoft.Authorization/policySetDefinitions",
            "apiVersion": "2021-06-01",
            "name": "Compliant-Storage-Account",
            "dependsOn": [
                "policyDefinitionCopy"
            ],
            "properties": {
                "metadata": {
                    "version": "1.0.0",
                    "category": "Storage"
                },
                "displayName": "Enforce secure-by-default Storage Account for Financial Services Industry",
                "description": "This policy initiative is a group of policies that ensures Storage is compliant per FSI Landing Zones",
                "policyDefinitionGroups": [
                    {
                        "name": "Encryption",
                        "category": "Data Protection",
                        "displayName": "Ensure Storage Account is using secure encryption",
                        "description": "Policy to ensure Storage Account is using secure encryption"
                    },
                    {
                        "name": "Network",
                        "category": "Network Security",
                        "displayName": "Ensure Storage Account is not accessible over the public internet",
                        "description": "Policy to ensure Storage Account is not accessible over the public internet"
                    },
                    {
                        "name": "Identity",
                        "category": "Identity Management",
                        "displayName": "Ensure usage of centralized identity and auhtorization system for Storage Account",
                        "description": "Policy to ensure Storage Account is not using local authorization"
                    },
                    {
                        "name": "Logging",
                        "category": "Logging and Threat Detection",
                        "displayName": "Ensure Storage Account is logging all events to Log Analytics",
                        "description": "Policy to ensure Storage Account is logging all events to Log Analytics workspace"
                    }
                ],
                "parameters": {
                    "storagePrivateDnsZoneId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storagePrivateDnsZone": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageKeysExipiration": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageFileSyncPrivateDnsZoneId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageFileSyncPrivateDnsZone": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "modifyStorageFileSyncPublicEndpoint": {
                        "type": "string",
                        "defaultValue": "Modify"
                    },
                    "modifyStorageAccountPublicEndpoint": {
                        "type": "string",
                        "defaultValue": "Modify"
                    },
                    "storageFileSyncPublicEndpoint": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageFileSyncDiagnostics": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageFileSyncLogAnalyticsWorkspaceId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageAccountNetworkRules": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageTableDiagnostics": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageTableLogAnalyticsWorkspaceId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageAccountRestrictNetworkRules": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageThreatProtection": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageClassicToArm": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountSecureTransfer": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsInfraEncryption": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsPublicAccess": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsDiagnostics": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageAccountsLogAnalyticsWorkspaceId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageFileDnsZone": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageFileDnsZoneId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageAccountsCmk": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageBlobPrivateDnsZoneId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageBlobPrivateDnsZone": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageQueueDiagnostics": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageQueueLogAnalyticsWorkspaceId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageTableCmk": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountSharedKey": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsCrossTenant": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsPrivateEndpoint": {
                        "type": "string",
                        "defaultValue": "DeployIfNotExists"
                    },
                    "storageAccountsPrivateEndpointSubnetId": {
                        "type": "string",
                        "defaultValue": ""
                    },
                    "storageAccountsModifyDisablePublicNetworkAccess": {
                        "type": "string",
                        "defaultValue": "Modify"                        
                    },
                    "storageAccountsDisablePublicNetworkAccess": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsDoubleEncryption": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsTrustedMsftServices": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageQueueCmk": {
                        "type": "string",
                        "defaultValue": "Deny"
                    },
                    "storageAccountsHttps": {
                        "type": "string",
                        "defaultValue": "Modify"
                    },
                    "storageAccountsTls": {
                        "type": "string",
                        "defaultValue": "Deny"
                    }
                },
                "policyDefinitions": [
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/fe83a0eb-a853-422d-aac2-1bffd182c5d0",
                        "policyDefinitionReferenceId": "Deny-Storage-Tls",
                        "groupNames": [
                            "Network",
                            "Encryption"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsTls')]"
                            }
                        }
                    },
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/f81e3117-0093-4b17-8a60-82363134f0eb",
                        "policyDefinitionReferenceId": "Modify-Storage-Https",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsHttps')]"
                            }
                        }
                    },
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/f0e5abd0-2554-4736-b7c0-4ffef23475ef",
                        "policyDefinitionReferenceId": "Deny-Storage-Queue-Cmk",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageQueueCmk')]"
                            }
                        }
                    },
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/c9d007d0-c057-4772-b18c-01e546713bcd",
                        "policyDefinitionReferenceId": "Deny-Storage-Account-Msft-Trusted",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsTrustedMsftServices')]"
                            }
                        }
                    },
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bfecdea6-31c4-4045-ad42-71b9dc87247d",
                        "policyDefinitionReferenceId": "Deny-Storage-Account-Encryption",
                        "groupNames": [
                            "Encryption"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsDoubleEncryption')]"
                            }
                        }
                    },
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b2982f36-99f2-4db5-8eff-283140c09693",
                        "policyDefinitionReferenceId": "Deny-Storage-Account-PublicEndpoint",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsDisablePublicNetworkAccess')]"
                            }
                        }
                    },
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/a06d0189-92e8-4dba-b0c4-08d7669fce7d",
                        "policyDefinitionReferenceId": "Modify-Storage-Account-PublicEndpoint",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsModifyDisablePublicNetworkAccess')]"
                            }
                        }
                    },
                    {   
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/9f766f00-8d11-464e-80e1-4091d7874074",
                        "policyDefinitionReferenceId": "Dine-Storage-Account-PrivateEndpoint",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsPrivateEndpoint')]"
                            },
                            "privateEndpointSubnetId": {
                                "value": "[[parameters('storageAccountsPrivateEndpointSubnetId')]"
                            }
                        }
                    },                    
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/92a89a79-6c52-4a7e-a03f-61306fc49312",
                        "policyDefinitionReferenceId": "Deny-Storage-Cross-Tenant",
                        "groupNames": [
                            "Encryption",
                            "Identity"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsCrossTenant')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/8c6a50c6-9ffd-4ae7-986f-5fa6111f9a54",
                        "policyDefinitionReferenceId": "Deny-Storage-Shared-Key",
                        "groupNames": [
                            "Encryption",
                            "Identity"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountSharedKey')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/7c322315-e26d-4174-a99e-f49d351b4688",
                        "policyDefinitionReferenceId": "Deny-Storage-Table-Cmk",
                        "groupNames": [
                            "Encryption"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageTableCmk')]"
                            }
                        }
                    },                    
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/7bd000e3-37c7-4928-9f31-86c4b77c5c45",
                        "policyDefinitionReferenceId": "Dine-Storage-Queue-Diagnostics",
                        "groupNames": [
                            "Logging"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageQueueDiagnostics')]"
                            },
                            "logAnalytics": {
                                "value": "[[parameters('storageQueueLogAnalyticsWorkspaceId')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/75973700-529f-4de2-b794-fb9b6781b6b0",
                        "policyDefinitionReferenceId": "Dine-Storage-Blob-PrivateDns",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageBlobPrivateDnsZone')]"
                            },
                            "privateDnsZoneId": {
                                "value": "[[parameters('storageBlobPrivateDnsZoneId')]"
                            }
                        }
                    },                    
                    {
                        "policyDefinitionId": "[concat(variables('scope'), '/providers/Microsoft.Authorization/policyDefinitions/', 'Deny-Storage-Cmk')]",
                        "policyDefinitionReferenceId": "Deny-Storage-Cmk",
                        "groupNames": [
                            "Encryption"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsCmk')]"
                            }
                        }
                    },               
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/6df98d03-368a-4438-8730-a93c4d7693d6",
                        "policyDefinitionReferenceId": "Dine-Storage-FileGroupId-Dns",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageFileDnsZone')]"
                            },
                            "privateDnsZoneId": {
                                "value": "[[parameters('storageFileDnsZoneId')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/59759c62-9a22-4cdf-ae64-074495983fef",
                        "policyDefinitionReferenceId": "Dine-Storage-Accounts-Diagnostics",
                        "groupNames": [
                            "Logging"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsDiagnostics')]"
                            },
                            "logAnalytics": {
                                "value": "[[parameters('storageAccountsLogAnalyticsWorkspaceId')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/4fa4b6c0-31ca-4c0d-b10d-24b96f62a751",
                        "policyDefinitionReferenceId": "Deny-Storage-Public-Access",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsPublicAccess')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/4733ea7b-a883-42fe-8cac-97454c2a9e4a",
                        "policyDefinitionReferenceId": "Deny-Storage-Infra-Encryption",
                        "groupNames": [
                            "Encryption"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountsInfraEncryption')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/404c3081-a854-4457-ae30-26a93ef643f9",
                        "policyDefinitionReferenceId": "Deny-Storage-SecureTransfer",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountSecureTransfer')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/37e0d2fe-28a5-43d6-a273-67d37d1f5606",
                        "policyDefinitionReferenceId": "Deny-Storage-Classic",
                        "groupNames": [
                            "Identity"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageClassicToArm')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/361c2074-3595-4e5d-8cab-4f21dffc835c",
                        "policyDefinitionReferenceId": "Dine-Storage-Threat-Protection",
                        "groupNames": [
                            "Logging"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageThreatProtection')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/34c877ad-507e-4c82-993e-3452a6e0ad3c",
                        "policyDefinitionReferenceId": "Deny-Storage-Restrict-NetworkRules",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountRestrictNetworkRules')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/2fb86bf3-d221-43d1-96d1-2434af34eaa0",
                        "policyDefinitionReferenceId": "Dine-Storage-Table-Diagnostics",
                        "groupNames": [
                            "Logging"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageTableDiagnostics')]"
                            },
                            "logAnalytics": {
                                "value": "[[parameters('storageTableLogAnalyticsWorkspaceId')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/2a1a9cdf-e04d-429a-8416-3bfb72a1b26f",
                        "policyDefinitionReferenceId": "Deny-Storage-NetworkRules",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageAccountNetworkRules')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/25a70cc8-2bd4-47f1-90b6-1478e4662c96",
                        "policyDefinitionReferenceId": "Dine-Storage-FileSync-Diagnostics",
                        "groupNames": [
                            "Logging"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageFileSyncDiagnostics')]"
                            },
                            "logAnalytics": {
                                "value": "[[parameters('storageFileSyncLogAnalyticsWorkspaceId')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/21a8cd35-125e-4d13-b82d-2e19b7208bb7",
                        "policyDefinitionReferenceId": "Deny-Storage-FileSync-PublicEndpoint",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageFileSyncPublicEndpoint')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/13502221-8df0-4414-9937-de9c5c4e396b",
                        "policyDefinitionReferenceId": "Modify-Api-Storage-Account-PublicEndpoint",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('modifyStorageAccountPublicEndpoint')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/0e07b2e9-6cd9-4c40-9ccb-52817b95133b",
                        "policyDefinitionReferenceId": "Modify-Storage-FileSync-PublicEndpoint",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('modifyStorageFileSyncPublicEndpoint')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/028bbd88-e9b5-461f-9424-a1b63a7bee1a",
                        "policyDefinitionReferenceId": "Dine-Storage-Account-Private-Dns",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "privateDnsZoneId": {
                                "value": "[[parameters('storagePrivateDnsZoneId')]"
                            },
                            "effect": {
                                "value": "[[parameters('storagePrivateDnsZone')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/044985bb-afe1-42cd-8a36-9d5d42424537",
                        "policyDefinitionReferenceId": "Deny-Storage-Account-Keys-Expire",
                        "groupNames": [
                            "Encryption"
                        ],
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('storageKeysExipiration')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/06695360-db88-47f6-b976-7500d4297475",
                        "policyDefinitionReferenceId": "Dine-Storage-File-Sync-Private-Dns",
                        "groupNames": [
                            "Network"
                        ],
                        "parameters": {
                            "privateDnsZoneId": {
                                "value": "[[parameters('storageFileSyncPrivateDnsZoneId')]"
                            },
                            "effect": {
                                "value": "[[parameters('storageFileSyncPrivateDnsZone')]"
                            }
                        }
                    }
                ]
            }
        }
    ]
}